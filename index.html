import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, limit, addDoc } from 'firebase/firestore';

// Define a paleta de cores oficial e outras constantes
const colors = {
  primaryPurple: '#8A2BE2', // Vaidade, Sofistica√ß√£o
  golden: '#FFD700',       // Gatilho Financeiro, Luxo
  red: '#FF0000',          // Necessidade, Urg√™ncia, Lux√∫ria
  black: '#000000',        // Eleg√¢ncia, Contraste
  white: '#FFFFFF',        // Clareza, Contraste
};

// Contexto para o usu√°rio e Firebase
const AppContext = createContext(null);

// Componente de Mensagem/Modal
const MessageBox = ({ message, onClose }) => {
  if (!message) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
        <p className="text-lg font-semibold text-gray-800 mb-4">{message}</p>
        <button
          onClick={onClose}
          className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
        >
          Fechar
        </button>
      </div>
    </div>
  );
};

// Componente de Spinner de Carregamento
const LoadingSpinner = () => (
  <div className="flex justify-center items-center h-full">
    <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-golden"></div>
  </div>
);

// Componente de Navega√ß√£o
const Navigation = ({ activeTab, setActiveTab }) => {
  const navItems = [
    { name: 'Home', icon: 'üè†' },
    { name: 'Jogar', icon: 'üéÆ' },
    { name: 'Carteira', icon: 'üí∞' },
    { name: 'Social', icon: 'ü§ù' },
  ];

  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-primaryPurple border-t border-golden shadow-lg z-40 md:static md:w-auto md:border-t-0 md:shadow-none md:flex md:flex-col md:space-y-4 md:p-4">
      <ul className="flex justify-around md:flex-col md:space-y-2">
        {navItems.map((item) => (
          <li key={item.name}>
            <button
              onClick={() => setActiveTab(item.name)}
              className={`flex flex-col items-center p-2 text-white font-semibold text-sm md:text-base rounded-lg transition duration-300 ${
                activeTab === item.name ? 'bg-golden text-primaryPurple' : 'hover:bg-golden hover:text-primaryPurple'
              }`}
            >
              <span className="text-xl md:text-2xl mb-1">{item.icon}</span>
              {item.name}
            </button>
          </li>
        ))}
      </ul>
    </nav>
  );
};

// Componente Dashboard
const Dashboard = () => {
  const { userData, setActiveTab } = useContext(AppContext);

  return (
    <div className="p-6 md:p-8 bg-white rounded-lg shadow-lg flex-grow overflow-y-auto">
      <h1 className="text-3xl md:text-4xl font-bold text-primaryPurple mb-6 text-center">Bem-vindo ao PizzaCoin!</h1>

      {/* Saldo de CalabrinCoins */}
      <div className="bg-gradient-to-r from-primaryPurple to-golden rounded-xl p-6 mb-8 shadow-md text-white text-center">
        <h2 className="text-xl md:text-2xl font-semibold mb-2">Seu Saldo de CalabrinCoins</h2>
        <p className="text-4xl md:text-5xl font-extrabold flex items-center justify-center">
          <img src="https://placehold.co/40x40/FFD700/8A2BE2?text=C" alt="CalabrinCoin" className="w-10 h-10 mr-2 rounded-full" />
          {userData?.calabrinBalance?.toFixed(2) || '0.00'}
        </p>
      </div>

      {/* Desafios Di√°rios */}
      <div className="mb-8">
        <h2 className="text-2xl md:text-3xl font-bold text-primaryPurple mb-4">Desafios Di√°rios</h2>
        <div className="space-y-4">
          <div className="bg-yellow-100 border-l-4 border-golden rounded-lg p-4 flex items-center justify-between shadow-sm">
            <div>
              <p className="font-semibold text-gray-800">Ganhe 3 Jogos</p>
              <p className="text-gray-600 text-sm">Recompensa: 600 CalabrinCoins</p>
            </div>
            <button className="bg-golden text-primaryPurple font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-500 transition duration-300">
              Jogar
            </button>
          </div>
          <div className="bg-yellow-100 border-l-4 border-golden rounded-lg p-4 flex items-center justify-between shadow-sm">
            <div>
              <p className="font-semibold text-gray-800">Colete 10 Ingredientes</p>
              <p className="text-gray-600 text-sm">Recompensa: 800 CalabrinCoins</p>
            </div>
            <button className="bg-golden text-primaryPurple font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-500 transition duration-300">
              Jogar
            </button>
          </div>
        </div>
      </div>

      {/* Feed Social (mock) */}
      <div className="mb-8">
        <h2 className="text-2xl md:text-3xl font-bold text-primaryPurple mb-4">Feed Social</h2>
        <div className="bg-gray-50 rounded-xl p-4 shadow-sm">
          <div className="flex items-center mb-3">
            <div className="w-10 h-10 bg-primaryPurple rounded-full flex items-center justify-center text-white font-bold mr-3">U</div>
            <div>
              <p className="font-semibold text-gray-800">NomeDeUsu√°rio</p>
              <p className="text-gray-600 text-sm">Acabou de fazer uma pizza deliciosa!</p>
            </div>
          </div>
          <div className="flex items-center mb-3">
            <div className="w-10 h-10 bg-golden rounded-full flex items-center justify-center text-primaryPurple font-bold mr-3">P</div>
            <div>
              <p className="font-semibold text-gray-800">PizzaLover22</p>
              <p className="text-gray-600 text-sm">Conquistou o badge "Speed Master"!</p>
            </div>
          </div>
        </div>
      </div>

      {/* Bot√£o de Jogar */}
      <div className="text-center mt-8">
        <button
          onClick={() => setActiveTab('Jogar')}
          className="bg-gradient-to-r from-red to-golden text-white text-2xl md:text-3xl font-bold py-4 px-12 rounded-full shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-105"
        >
          JOGAR AGORA
        </button>
      </div>
    </div>
  );
};

// Componente PizzaBuilderGame
const PizzaBuilderGame = () => {
  const { updateUserData, showMessage } = useContext(AppContext);
  const [pizzaIngredients, setPizzaIngredients] = useState([]);
  const [score, setScore] = useState(0);
  const [timer, setTimer] = useState(120); // 2 minutos
  const [gameStarted, setGameStarted] = useState(false);
  const [gameFinished, setGameFinished] = useState(false);
  const [message, setMessage] = useState('');

  const ingredients = [
    { name: 'Pepperoni', icon: 'üçï', points: 10 },
    { name: 'Mozzarella', icon: 'üßÄ', points: 8 },
    { name: 'Cogumelos', icon: 'üçÑ', points: 7 },
    { name: 'Manjeric√£o', icon: 'üåø', points: 6 },
    { name: 'Tomate', icon: 'üçÖ', points: 5 },
    { name: 'Azeitonas', icon: 'ü´í', points: 9 },
    { name: 'Cebola', icon: 'üßÖ', points: 6 },
    { name: 'Piment√£o', icon: 'üå∂Ô∏è', points: 7 },
  ];

  useEffect(() => {
    let interval;
    if (gameStarted && timer > 0 && !gameFinished) {
      interval = setInterval(() => {
        setTimer((prevTimer) => prevTimer - 1);
      }, 1000);
    } else if (timer === 0 && gameStarted && !gameFinished) {
      finishGame();
    }
    return () => clearInterval(interval);
  }, [gameStarted, timer, gameFinished]);

  const startGame = () => {
    setPizzaIngredients([]);
    setScore(0);
    setTimer(120);
    setGameStarted(true);
    setGameFinished(false);
    showMessage('Jogo iniciado! Crie sua pizza!');
  };

  const addIngredient = (ingredient) => {
    if (!gameStarted || gameFinished) return;
    setPizzaIngredients((prev) => [...prev, ingredient]);
    setScore((prev) => prev + ingredient.points);
  };

  const finishGame = async () => {
    setGameFinished(true);
    setGameStarted(false);
    const calabrinEarned = score / 10; // Exemplo de c√°lculo
    const xpEarned = score / 5; // Exemplo de c√°lculo

    await updateUserData({
      calabrinBalance: calabrinEarned,
      xp: xpEarned,
      transactions: {
        type: 'game_reward',
        amount: calabrinEarned,
        description: `Pizza criada - ${score} pontos`,
        timestamp: new Date().toISOString(),
      },
    });

    showMessage(`Jogo finalizado! Voc√™ ganhou ${calabrinEarned.toFixed(2)} CalabrinCoins e ${xpEarned.toFixed(0)} XP!`);
  };

  const formatTime = (seconds) => {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
  };

  return (
    <div className="p-6 md:p-8 bg-white rounded-lg shadow-lg flex-grow overflow-y-auto flex flex-col items-center">
      <h1 className="text-3xl md:text-4xl font-bold text-primaryPurple mb-6 text-center">Pizza Builder</h1>

      <div className="bg-primaryPurple rounded-xl p-6 mb-6 w-full max-w-md shadow-md">
        <div className="flex justify-between items-center text-white text-lg font-semibold mb-4">
          <span>Tempo: {formatTime(timer)}</span>
          <span>Pontua√ß√£o: {score}</span>
        </div>

        {/* √Årea da Pizza */}
        <div className="relative w-64 h-64 md:w-80 md:h-80 bg-yellow-300 rounded-full mx-auto border-4 border-golden flex items-center justify-center overflow-hidden">
          {/* Base da pizza */}
          <img
            src="https://placehold.co/250x250/FFD700/8A2BE2?text=Pizza+Base"
            alt="Pizza Base"
            className="absolute w-full h-full object-cover rounded-full"
          />
          {/* Ingredientes adicionados */}
          {pizzaIngredients.map((ing, index) => (
            <span
              key={index}
              className="absolute text-3xl"
              style={{
                top: `${Math.random() * 80 + 10}%`,
                left: `${Math.random() * 80 + 10}%`,
                transform: `translate(-50%, -50%) rotate(${Math.random() * 360}deg)`,
              }}
            >
              {ing.icon}
            </span>
          ))}
        </div>

        {/* Bot√µes de A√ß√£o */}
        <div className="flex justify-center space-x-4 mt-6">
          {!gameStarted && !gameFinished && (
            <button
              onClick={startGame}
              className="bg-gradient-to-r from-red to-golden text-white font-bold py-3 px-8 rounded-full shadow-md hover:shadow-lg transition duration-300"
            >
              COME√áAR JOGO
            </button>
          )}
          {gameStarted && !gameFinished && (
            <>
              <button
                onClick={finishGame}
                className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-md transition duration-300"
              >
                FINALIZAR PIZZA
              </button>
              <button
                onClick={() => setGameStarted(false)} // Simula pausa
                className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-full shadow-md transition duration-300"
              >
                PAUSAR
              </button>
            </>
          )}
          {gameFinished && (
             <button
             onClick={startGame}
             className="bg-gradient-to-r from-red to-golden text-white font-bold py-3 px-8 rounded-full shadow-md hover:shadow-lg transition duration-300"
           >
             JOGAR NOVAMENTE
           </button>
          )}
        </div>
      </div>

      {/* Sele√ß√£o de Ingredientes */}
      <div className="bg-gray-100 rounded-xl p-4 w-full max-w-md shadow-inner">
        <h3 className="text-xl font-bold text-primaryPurple mb-3 text-center">Ingredientes</h3>
        <div className="grid grid-cols-4 gap-3">
          {ingredients.map((ing) => (
            <button
              key={ing.name}
              onClick={() => addIngredient(ing)}
              disabled={!gameStarted || gameFinished}
              className={`flex flex-col items-center p-2 rounded-lg shadow-sm transition duration-200
                ${gameStarted && !gameFinished ? 'bg-white hover:bg-gray-200' : 'bg-gray-200 cursor-not-allowed'}
                ${gameStarted && !gameFinished ? 'active:scale-95' : ''}
              `}
            >
              <span className="text-3xl">{ing.icon}</span>
              <span className="text-xs font-semibold text-gray-700 mt-1">{ing.name}</span>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
};

// Componente Wallet
const Wallet = () => {
  const { userData, showMessage } = useContext(AppContext);
  const [conversionAmount, setConversionAmount] = useState('');
  const [convertedValue, setConvertedValue] = useState(0);
  const [fromCurrency, setFromCurrency] = useState('CALABRIN');
  const [toCurrency, setToCurrency] = useState('BRL');

  // Taxas de convers√£o simuladas (baseado na documenta√ß√£o)
  const rates = {
    CALABRIN_USD: 0.05,
    CALABRIN_BRL: 0.25,
    USD_BRL: 5.0,
  };

  const handleConversionAmountChange = (e) => {
    const value = parseFloat(e.target.value);
    if (!isNaN(value) && value >= 0) {
      setConversionAmount(value);
      calculateConversion(value, fromCurrency, toCurrency);
    } else {
      setConversionAmount('');
      setConvertedValue(0);
    }
  };

  const calculateConversion = (amount, from, to) => {
    let result = 0;
    if (from === 'CALABRIN' && to === 'BRL') {
      result = amount * rates.CALABRIN_BRL;
    } else if (from === 'CALABRIN' && to === 'USD') {
      result = amount * rates.CALABRIN_USD;
    } else if (from === 'BRL' && to === 'CALABRIN') {
      result = amount / rates.CALABRIN_BRL;
    } else if (from === 'USD' && to === 'CALABRIN') {
      result = amount / rates.CALABRIN_USD;
    } else if (from === 'USD' && to === 'BRL') {
      result = amount * rates.USD_BRL;
    } else if (from === 'BRL' && to === 'USD') {
      result = amount / rates.USD_BRL;
    }
    setConvertedValue(result);
  };

  const handleConvert = async () => {
    if (conversionAmount <= 0 || conversionAmount > userData.calabrinBalance) {
      showMessage('Valor inv√°lido ou saldo insuficiente para convers√£o.');
      return;
    }

    const fee = conversionAmount * 0.005; // 0.5% transaction fee
    const netAmount = conversionAmount - fee;
    const finalConvertedValue = netAmount * rates.CALABRIN_BRL; // Assumindo CALABRIN para BRL para simplifica√ß√£o

    await updateUserData({
      calabrinBalance: -conversionAmount, // Reduz o saldo de Calabrin
      transactions: {
        type: 'conversion_out',
        amount: conversionAmount,
        description: `Convers√£o de ${conversionAmount.toFixed(2)} CALABRIN para ${finalConvertedValue.toFixed(2)} ${toCurrency} (Taxa: ${fee.toFixed(2)})`,
        timestamp: new Date().toISOString(),
      },
    });

    showMessage(`Convers√£o de ${conversionAmount.toFixed(2)} CALABRIN para ${finalConvertedValue.toFixed(2)} ${toCurrency} realizada com sucesso!`);
    setConversionAmount('');
    setConvertedValue(0);
  };

  return (
    <div className="p-6 md:p-8 bg-white rounded-lg shadow-lg flex-grow overflow-y-auto">
      <h1 className="text-3xl md:text-4xl font-bold text-primaryPurple mb-6 text-center">Sua Carteira Digital</h1>

      {/* Saldo Atual */}
      <div className="bg-gradient-to-r from-primaryPurple to-golden rounded-xl p-6 mb-8 shadow-md text-white text-center">
        <h2 className="text-xl md:text-2xl font-semibold mb-2">Saldo de CalabrinCoins</h2>
        <p className="text-4xl md:text-5xl font-extrabold flex items-center justify-center">
          <img src="https://placehold.co/40x40/FFD700/8A2BE2?text=C" alt="CalabrinCoin" className="w-10 h-10 mr-2 rounded-full" />
          {userData?.calabrinBalance?.toFixed(2) || '0.00'}
        </p>
      </div>

      {/* Conversor de Moedas */}
      <div className="mb-8 bg-gray-50 rounded-xl p-6 shadow-sm">
        <h2 className="text-2xl md:text-3xl font-bold text-primaryPurple mb-4">Conversor de Moedas</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label htmlFor="fromCurrency" className="block text-gray-700 text-sm font-semibold mb-2">De</label>
            <select
              id="fromCurrency"
              className="w-full p-3 border border-primaryPurple rounded-lg focus:outline-none focus:ring-2 focus:ring-golden"
              value={fromCurrency}
              onChange={(e) => {
                setFromCurrency(e.target.value);
                calculateConversion(conversionAmount, e.target.value, toCurrency);
              }}
            >
              <option value="CALABRIN">CalabrinCoin</option>
              <option value="USD">USD</option>
              <option value="BRL">BRL</option>
            </select>
          </div>
          <div>
            <label htmlFor="toCurrency" className="block text-gray-700 text-sm font-semibold mb-2">Para</label>
            <select
              id="toCurrency"
              className="w-full p-3 border border-primaryPurple rounded-lg focus:outline-none focus:ring-2 focus:ring-golden"
              value={toCurrency}
              onChange={(e) => {
                setToCurrency(e.target.value);
                calculateConversion(conversionAmount, fromCurrency, e.target.value);
              }}
            >
              <option value="BRL">BRL</option>
              <option value="USD">USD</option>
              <option value="CALABRIN">CalabrinCoin</option>
            </select>
          </div>
        </div>
        <div className="mb-4">
          <label htmlFor="amount" className="block text-gray-700 text-sm font-semibold mb-2">Valor para Converter</label>
          <input
            type="number"
            id="amount"
            className="w-full p-3 border border-primaryPurple rounded-lg focus:outline-none focus:ring-2 focus:ring-golden"
            placeholder="0.00"
            value={conversionAmount}
            onChange={handleConversionAmountChange}
          />
        </div>
        <div className="text-center text-xl font-bold text-gray-800 mb-6">
          {convertedValue.toFixed(2)} {toCurrency}
        </div>
        <button
          onClick={handleConvert}
          className="w-full bg-gradient-to-r from-red to-golden text-white font-bold py-3 px-6 rounded-full shadow-md hover:shadow-lg transition duration-300"
        >
          Converter
        </button>
      </div>

      {/* Hist√≥rico de Transa√ß√µes */}
      <div className="mb-8 bg-gray-50 rounded-xl p-6 shadow-sm">
        <h2 className="text-2xl md:text-3xl font-bold text-primaryPurple mb-4">Hist√≥rico de Transa√ß√µes</h2>
        {userData?.transactions && userData.transactions.length > 0 ? (
          <ul className="space-y-3">
            {userData.transactions.map((tx, index) => (
              <li key={index} className="bg-white p-4 rounded-lg shadow-sm border-l-4 border-golden flex justify-between items-center">
                <div>
                  <p className="font-semibold text-gray-800">{tx.description}</p>
                  <p className="text-gray-600 text-sm">{new Date(tx.timestamp).toLocaleString()}</p>
                </div>
                <span className={`font-bold ${tx.type.includes('out') ? 'text-red-600' : 'text-green-600'}`}>
                  {tx.type.includes('out') ? '-' : '+'}{tx.amount.toFixed(2)} CALABRIN
                </span>
              </li>
            ))}
          </ul>
        ) : (
          <p className="text-gray-600 text-center">Nenhuma transa√ß√£o ainda.</p>
        )}
      </div>
    </div>
  );
};

// Componente Social (Simplificado)
const S
